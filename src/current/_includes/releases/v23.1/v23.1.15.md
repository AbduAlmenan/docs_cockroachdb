## v23.1.15

Release Date: February 16, 2024

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-15-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Fixed a bug where changefeeds that targeted schema-locked tables could fail due to a very old highwater timestamp being incorrectly persisted. [#117960][#117960]
- Fixed a bug where creating a changefeed that targeted tables with a `DECIMAL(n)` column (i.e. zero-scale `DECIMAL` column), `format='avro'`, and `diff` would cause a panic. [#118893][#118893]

<h3 id="v23-1-15-operational-changes">Operational changes</h3>

- Per-node tot ranges logging now logs local top 5 hot ranges instead of top 5 cluster-wide hot ranges. [#118371][#118371]

<h3 id="v23-1-15-bug-fixes">Bug fixes</h3>

- CDC custom key column now functions with CDC queries correctly. For example, `CREATE CHANGEFEED WITH key_column=..., unordered AS SELECT * FROM table` now works correctly instead of retrying forever. Note that some functionalities with CDC custom keys are not fully supported, see 115267 for more details. [#116966][#116966]
- Fixed a bug that prevented database RESTORE when the database contained a view or routine that referenced a user-defined type in the body string. For views, this bug was introduced in v20.2, when UDTs were introduced. For routines, this bug was introduced in v22.2, when UDFs were introduced. [#116903][#116903]
- This commit fixes a durability bug in raft log storage, caused by incorrect syncing of filesystem metadata. It was possible to lose writes of a particular kind (AddSSTable) that is e.g. used by RESTORE. This loss was possible only under power-off or OS crash conditions. As a result, CRDB could enter a crash loop on restart. In the worst case of a coordinated power-off/crash across multiple nodes this could lead to an unrecoverable loss of quorum. [#117383][#117383]
- Fix value used for the total runtime on sql stats, which was using the wrong value previously, causing the UI to display values with more than 100%. [#117496][#117496]
- Trying to set an empty search_path no longer results in an error. [#117556][#117556]
- This commit fixes a bug in raft log truncation that could lead to crash loops, and unrecoverable loss of quorum in the unlikely worst case that all replicas enter this crash loop. The bug manifests when a few things coincide. The cluster is running a bulk write workload (e.g. schema change, import, restore), a log truncation command is running, and CRDB process crashes at an unfortunate moment (e.g. the process is killed, or kills itself for reasons like when it detects a disk stall). [#117299][#117299]
- Fixed a bug in the row-level TTL job that would cause it to skip expired rows if the primary key of the table included columns of the collated string type. This bug was present since the initial release of row-level TTL in v22.2.0. [#117513][#117513]
- Fixed a bug where concurrent GRANTs can cause deadlocks. [#117712][#117712]
- This commit reduces the impact of bulk deletions (DROP TABLEs, TRUNCATE TABLEs, or replica removals) on foreground traffic by altering storage engine compaction priorities. [#116560][#116560]
- CDC custom key column now functions with CDC queries correctly. For example, `CREATE CHANGEFEED WITH key_column=..., unordered AS SELECT * FROM table` now works correctly instead of retrying forever. Note that some functionalities with CDC custom keys are not fully supported, see 115267 for more details. [#118141][#118141]
- Fix value used for the total runtime on sql stats, which was using the wrong value previously, causing the UI to display values with more than 100%. [#118141][#118141]
- Fixed a bug that caused DML to fail while a hash-sharded index was being created. The symptom of this bug was an error like `column "crdb_internal_val_shard_16" does not exist`. This bug was present since v23.1.0. [#118238][#118238]
- Previously, CockroachDB could encounter an error "unable to encode table key: *tree.DTSQuery" when operating on columns of TSQuery type in some contexts (e.g. when collecting table statistics or when performing a DISTINCT operation), and this is now fixed. The bug has been present since 23.1 when support for TSQuery type was added. [#118320][#118320]
- Previously, in some cases CockroachDB could incorrectly evaluate queries that scanned an inverted index and had a `WHERE` filter in which two sides of the `AND` expression had "similar" expressions (e.g. `ARRAY['str1'] <@ col AND (ARRAY['str1'] && col OR ...)`), and this is now fixed. The bug has been present since pre-22.2 version. [#118359][#118359]
- Fixed a bug that could cause DELETE queries sent by the row-level TTL job to use a secondary index rather than the primary index to find the rows to delete. This could lead to some DELETE operations taking a much longer time than they should. This bug was present since v22.2.0. [#118336][#118336]
- Recalculate properly the value from current and past hour on top Activity table, fixing the issue where we were missing data on sql stats and consequently missing data on the SQL Activity page. [#118427][#118427]
- Internal queries issued by the TTL jobs should now use optimal plans. The bug has been present since at least 22.2 version. [#118564][#118564]
- AUTO CREATE STATS jobs could previously lead to growth in an internal system table resulting in slower job-system related queries. [#118980][#118980]
- ALTER PRIMARY KEY could fail with a "non-nullable column <x> with no value! Index scanned .." when validating recreated secondary indexes. [#118969][#118969]

<h3 id="v23-1-15-miscellaneous">Miscellaneous</h3>

<h4 id="v23-1-15-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#118919][#118919] [ce971160e][ce971160e] release-23.1.15-rc: sql/row: include pretty key in value decode error message (Jayant Shrivastava <jshrivastava03@gmail.com>)
- [#118590][#118590] [566a30300][566a30300] release-23.1.15-rc: structlogging: fix hot ranges test for tenants (Xin Hao Zhang <xzhang@cockroachlabs.com>)
- [#117742][#117742] [7667710a0][7667710a0]  (Renato Costa <renato@cockroachlabs.com>)

<h3 id="v23-1-15-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-15-contributors">Contributors</h3>

This release includes 96 merged PRs by 39 authors.
We would like to thank the following contributors from the CockroachDB community:

- Nikolai Vladimirov (first-time contributor)
- lyang24 (first-time contributor)
- rharding6373

</div>

[#116560]: https://github.com/cockroachdb/cockroach/pull/116560
[#116903]: https://github.com/cockroachdb/cockroach/pull/116903
[#116966]: https://github.com/cockroachdb/cockroach/pull/116966
[#117299]: https://github.com/cockroachdb/cockroach/pull/117299
[#117383]: https://github.com/cockroachdb/cockroach/pull/117383
[#117496]: https://github.com/cockroachdb/cockroach/pull/117496
[#117513]: https://github.com/cockroachdb/cockroach/pull/117513
[#117556]: https://github.com/cockroachdb/cockroach/pull/117556
[#117712]: https://github.com/cockroachdb/cockroach/pull/117712
[#117742]: https://github.com/cockroachdb/cockroach/pull/117742
[#117960]: https://github.com/cockroachdb/cockroach/pull/117960
[#118141]: https://github.com/cockroachdb/cockroach/pull/118141
[#118238]: https://github.com/cockroachdb/cockroach/pull/118238
[#118320]: https://github.com/cockroachdb/cockroach/pull/118320
[#118336]: https://github.com/cockroachdb/cockroach/pull/118336
[#118359]: https://github.com/cockroachdb/cockroach/pull/118359
[#118371]: https://github.com/cockroachdb/cockroach/pull/118371
[#118427]: https://github.com/cockroachdb/cockroach/pull/118427
[#118564]: https://github.com/cockroachdb/cockroach/pull/118564
[#118590]: https://github.com/cockroachdb/cockroach/pull/118590
[#118893]: https://github.com/cockroachdb/cockroach/pull/118893
[#118919]: https://github.com/cockroachdb/cockroach/pull/118919
[#118969]: https://github.com/cockroachdb/cockroach/pull/118969
[#118980]: https://github.com/cockroachdb/cockroach/pull/118980
[566a30300]: https://github.com/cockroachdb/cockroach/commit/566a30300
[7667710a0]: https://github.com/cockroachdb/cockroach/commit/7667710a0
[ce971160e]: https://github.com/cockroachdb/cockroach/commit/ce971160e
