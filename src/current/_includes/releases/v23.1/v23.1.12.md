## v23.1.12

Release Date: October 31, 2023

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-12-security-updates">Security updates</h3>

- The SIGHUP signal will now clear the cached expiration times for client certificates that are reported by the security.certificate.expiration.client metric. [#111006][#111006]
- Endpoints in the admin and status server that previously required the admin role now can be used by users with the VIEWCLUSTERMETADATA or REPAIRCLUSTERMETADATA system privilege, depending on whether the endpoint is read-only or can modify state. [#111131][#111131]

<h3 id="v23-1-12-general-changes">General changes</h3>

- Fixed a bug where, internally, if we print a 0 decimal with a very low exponent we use excessive memory. This is not possible through using the decimal type, but may be possible through crdb_internal functions. [#110564][#110564]
- This change prevents OOMs from happening when executing the "EXPORT INTO PARQUET" statement. Now, if memory is exceeded, the "EXPORT INTO PARQUET" statement will return an error. If one sees an error releated to memory, they can retry the export using a smaller `chunk_rows` (see https://www.cockroachlabs.com/docs/stable/export#export-options). The docs can mention that `chunk_rows` can be used to manage memory.  It's also worth noting that using changefeeds to export data into parquet files is more preferable because they are more resilient, efficient, and scalable than `EXPORT INTO`. [#110717][#110717]
- Increased the maximum permitted value of the COCKROACH_RPC_INITIAL_WINDOW_SIZE environment variable to 64MB. When used in conjunction with a tuned OS-level maximum TCP window size, this can increase the throughput that Raft replication can sustain over high latency network links. [#111287][#111287]
- Update Go version to 1.19.13 Release justification: update Golang patch release [#112204][#112204]

<h3 id="v23-1-12-sql-language-changes">SQL language changes</h3>

- Deflake TestDropTableWhileUpgradingFormat [#110246][#110246]
- This commit introduces the cluster setting `sql.stats.limit_table_size.enabled` which controls whether or not we enforce the row limit set by `sql.stats.persited_rows.max` in the system.{statement,transaction} statistics tables. [#110246][#110246]
- Optimized the sql-stats-compaction job delete query to avoid full scan. This helps avoid the TransactionRetryError which can cause the job to fail. [#110246][#110246]
- Introspection queries will now show the internal `node` user as the owner of tables in pg_catalog and information_schema. Previously the owner was shown as `admin`, but that was inaccurate since users with the `admin` role could not modify these tables in any way. [#110246][#110246]
- Datetime built-ins (make_date, make_timestamp, and make_timestamptz) are implemented - allowing for the creation of timestamps, timestamps with time zones, and dates. In addition, date_trunc now allows for a timestamp to be truncated in a provided timezone (to a provided precision). [#110338][#110338]
- There is now a `CREATEROLE` system privilege, which is analogous to the existing `CREATEROLE` role option, but can also be inherited by role membership. [#110359][#110359]
- There is now a `CREATELOGIN` system privilege, which is analogous to the existing `CREATELOGIN` role option, but can also be inherited by role membership. [#110359][#110359]
- There is now a `CREATEDB` system privilege, which is analogous to the existing `CREATEDB` role option, but can also be inherited by role membership. [#110359][#110359]
- There is now a `CONTROLJOB` system privilege, which is analogous to the existing `CONTROLJOB` role option, but can also be inherited by role membership. [#110359][#110359]
- RESTORE can now be passed a WITH EXECUTION LOCALITY option similar to BACKUP, to restrict execution of the job to nodes with matching localities. Epic: CRDB-28521. [#110611][#110611]
- The `statement_activity` and `transaction_activity` table column `execution_total_cluster_seconds` is now accurate. The `combinedstmts` endpoint returns the correct value for the `StmtsTotalRuntimeSecs` and `TxnsTotalRuntimeSecs` properties. [#109639][#109639]
- SQL commands that were previously only usable by users with the admin role can now be used by users with the VIEWCLUSTERMETADATA or REPAIRCLUSTERMETADATA system privilege, depending on whether the operation is read-only or modifies state. [#111058][#111058]
- The discard log message is now limited to once per minute by default. The message was also changed to have both the number of transactions and the number of statements that were discarded. [#110983][#110983]
- Adds the `updates_cluster_monitoring_metrics` backup option that allows an operator to opt-in tracking the timestamp of the last backup failure due to a KMS error. [#111310][#111310]
- Vectorized COPY FROM support didn't properly handle schemas hash sharded primary keys. Epic: none  Release justification: fix for regression in COPY with hash sharded tables. [#111412][#111412]
- Fix a bug that causes the sql stats to stop collecting new stats. [#111641][#111641]
- Reduces the sql activity job memory usage. [#112323][#112323]

<h3 id="v23-1-12-operational-changes">Operational changes</h3>

- Introduce the kv.enqueue_in_replicate_queue_on_span_config_update.enabled cluster setting. When set to true, stores in the cluster will enqueue replicas for replication changes, upon receiving config updates which could affect the replica. This setting is off by default. Enabling this setting speeds up how quickly config triggered replication changes begin, but adds additional CPU overhead. The overhead scales with the number of leaseholders. [#110246][#110246]
- The RPC dial and heartbeat timeouts can now be configured via the environment variables COCKROACH_RPC_DIAL_TIMEOUT (default 2x COCKROACH_NETWORK_TIMEOUT or 2x2=4 seconds) and COCKROACH_RPC_HEARTBEAT_TIMEOUT (default 3x COCKROACH_NETWORK_TIMEOUT or 3x2=6 seconds). This allows configuring these values independently of COCKROACH_NETWORK_TIMEOUT. [#110246][#110246]
- The default gRPC server-side send timeout has been increased from 2 seconds to 4 seconds (1x to 2x of COCKROACH_NETWORK_TIMEOUT), to avoid spurious connection failures in certain scenarios. This can be controlled via the new environment variable COCKROACH_RPC_SERVER_TIMEOUT. [#110246][#110246]
- Added a new sql.schema.invalid_objects gauge metric. This gauge is periodically updated based on the schedule set by the sql.schema.telemetry.recurrence cluster setting. When it is updated, it counts the number of schema objects (tables, types, schemas, databases, and functions) that are in an invalid state according to CockroachDBâ€™s internal validation checks. This metric is expected to be zero in a healthy cluster, and if it is not, it indicates that there is a problem that must be repaired. [#110246][#110246]
- The `debug zip` command now has an option to omit goroutine stack dumps by. This impacts the creation of `nodes/*/stacks.txt` and `nodes/*/stacks_with_labels.txt` within debug zip bundles. Users can opt to exclude these goroutine stacks by using the `--include-goroutine-stacks=false` flag.  Note that fetching stack traces for all goroutines is a "stop-the-world" operation, which can momentarily have negative impacts on SQL service latency. Note that any periodic goroutine dumps previously taken on the node will still be included in `nodes/*/goroutines/*.txt.gz`, as these would have already been generated and don't require any stop-the-world operations. [#110266][#110266]
- Requests for database details or table details from the UI, or usages of `SHOW RANGES WITH DETAILS` are no longer subject to errors if the number of requested spans is too large. [#109902][#109902]
- A new metric `changefeed.lagging_ranges` is added to show the number of ranges which are behind in changefeeds. This metric can be used with the `metrics_label` changefeed option. A new cluser setting `changefeed.lagging_ranges_threshold` is added which is the amount of time a range needs to be behind to be considered lagging. By default this is 3 minutes. There is also a new cluster setting `changefeed.lagging_ranges_polling_interval` which controls how often the lagging ranges calculation is done. This setting defaults to polling every 1 minute.  Note that polling adds latency to the metric being updated. For example, if a range falls behind by 3 minutes, the metric may not update until an additional minute afterwards.  Also note that ranges undergoing an initial scan for longer than the threshold are considered to be lagging. Starting a changefeed with an initial scan on a large table will likely increment the metric for each range in the table. However, as ranges complete the initial scan, the number of ranges will decrease.  Epic: CRDB-9181 [#110963][#110963]
- The DB Console now constructs client-side requests using relative URLs instead of absolute ones. This enables proxying of the DB Console at arbitrary subpaths. [#111652][#111652]
- A new cluster setting `server.http.base_path` is introduced that currently controls the redirection of the browser after successful login with OIDC SSO. It is expected that most customers should *not* have to adjust this. This is helpful in cases where a customer is running CRDB behind a load- balancer or proxy that serves CRDB under a subpath such as `https:// <hostname>/crdb/ `. In those cases it's necessary for the browser to redirect to `/ crdb` after login instead of `/` which has always been the hardcoded default. [#112038][#112038]

<h3 id="v23-1-12-command-line-changes">Command-line changes</h3>

- Added limited statement_statistics to the debug zip. [#110662][#110662]

<h3 id="v23-1-12-db-console-changes">DB Console changes</h3>

- Allow non-admin users to view the databases page. [#110342][#110342]
- Non-admin users are able to use the database details page. [#110369][#110369]
- The "SQL Connection Rate" metric on the SQL Dashboard is downsampled using the MAX function instead of SUM. This improves situations where zooming out would cause the connection rate to increase for downsampled data. [#110497][#110497]
- Non-admin users are able to use the database table page. [#110680][#110680]
- Fixes the statement diagnostics page when the response hit a max size error. [#111278][#111278]
- Fixes an error on the activity page when there was a workload and then the workload stopped so no queries ran against the db in the last hour. [#111496][#111496]
- Correctly display timestamps for creation, last modified, and completed time on Jobs table. [#111901][#111901]

<h3 id="v23-1-12-bug-fixes">Bug fixes</h3>

- Fixed a nil dereference panic during node startup that could be caused by an incorrect initialization order. [#109684][#109684]
- Fixed a bug where the BEGIN statement would appear in telemetry logs with the wrong transaction ID. Now, it will show no transaction ID, since there is no transaction open at the time that BEGIN is executed. [#109840][#109840]
- Fixed a bug that could cause a transaction performing multiple parallel foreign key checks to return a `concurrent txn use detected` error. [#109849][#109849]
- Fixed a bug where dependencies on sequences from tables would be reported with the wrong value for the classid column in the pg_catalog.pg_depend table. [#110207][#110207]
- Fixes errors on the Sessions page UI when a session's memory usage is zero bytes. [#110246][#110246]
- Fix bug that could cause CPU usage to increase over time. [#110246][#110246]
- Fixed a bug introduced in v22.1 that could cause a join to infinite-loop in rare cases when (1) the join filter is not an equality and (2) no columns from the left input are returned. [#110246][#110246]
- Fixes the `fullScan` attribute when reading from sqlstats to be true when there is at least one fullScanCount in the metadata. [#110246][#110246]
- This patch fixes a bug in geospatial queries, where a query filter of the form `ST_Distance(geog1, geog2) > constant`, or `ST_MaxDistance(geom1, geom2) > constant`, where the operator is one of >, <, >=, <=, or a filter of the form `ST_Distance(geog1, geog2, false) = 0` may mistakenly evaluate to `true` when one or both of the inputs is null or an empty geography/geometry. More rows could be returned by the query than expected. [#110246][#110246]
- Fixed a bug that could cause some rows to be silently skipped during IMPORT when a node failed. [#110246][#110246]
- Fixes an issue where a split can be called on an invalid key that's in the form of someValidKey.Next() during restore. This split key can land in the middle of a row with column families, and thus result in failing SQL queries when querying the restored table. [#110246][#110246]
- Fixes an issue where a split can be called on an invalid key that's in the form of someValidKey.Next() during restore with `bulkio.restore.use_simple_import_spans=true`. This split key can land in the middle of a row with column families, and thus result in failing SQL queries when querying the restored table. [#110246][#110246]
- On CC, `Rest Sql Stats` button is now visible if the user has admin role. [#110256][#110256]
- Fixed edge cases in decimal and float evaluation for division operators. `'NaN'::DECIMAL / 0` will now return `NaN` instead of a division-by-zero error, and `0 / 'inf'::DECIMAL` will return `0` instead of `0E-2019`. [#110296][#110296]
- Fixed a UI issue where the DROP_UNUSED index recommendations produced by the table details page produced an invalid `DROP INDEX` statement. [#110453][#110453]
- Two `ALTER RANGE default CONFIGURE ZONE` statements on the same line no longer displays an error. Fixes: #108253 Release justification: small bugfix [#110337][#110337]
- Remove buggy TTL descriptor repair. Previously, upgrading from 22.2.X to 23.1.9 incorrectly removed TTL storage params from tables (visible via `SHOW CREATE TABLE <ttl-table>;`) while attempting to repair table descriptors. This resulted in the node that attempts to run the TTL job crashing due to a panic caused by the missing TTL storage params. Clusters currently on 22.2.X should NOT be upgraded to 23.1.9 and should be upgraded to 23.1.10 or later directly. [#110500][#110500]
- Fixes a bug causing performance regression when disabling `sql.metrics.statement_details.enabled` which caused execution stats to be collected for all queries instead of the default one percent. [#109881][#109881]
- `cockroach debug pebble` commands now work correctly with encrypted stores which don't use the default `cockroach-data` path without having to also pass `--store`. [#110507][#110507]
- Avoid displaying `undefined` regions on the databases pages. [#110741][#110741]
- `RESET (ttl_expire_after)` no longer incorrectly removes `ttl_expiration_expression`. [#110746][#110746]
- `ALTER TABLE ... ADD CONSTRAINT CHECK ...` statements that utilize a UDF in the CHECK no longer cause a validation error. [#110720][#110720]
- CREATE INDEX for partial indexes could fail with "ERROR: duplicate key value violates unique constraint" if concurrent inserts happened simultaneously. [#110584][#110584]
- CREATE TABLE with IDENTITY columns did not properly propagate the type of the column into the sequence. [#111014][#111014]
- Format_type builtin did not honour typemod information for array types, leading to incorrect output. [#110940][#110940]
- Fixes pathological compaction behavior that could result in rapid growth of sublevels when removing replicas from a store (eg, during decomissioning). [#111141][#111141]
- Previously, when evaluating some queries (most likely with a lookup join) via "multiple active portals" execution mode (preview feature that can be enabled via `multiple_active_portals_enabled` session variable) CockroachDB could encounter an internal error like `unexpected 40960 leftover bytes` if that portal wasn't fully consumed. This is now fixed. [#110666][#110666]
- External connection URLs now accept the scheme `azure-blob` for connections to Azure Blob Storage and the scheme `azure-kms` for connections to Azure KMS. For backward compatibility, schemes `azure` and `azure-storage` schemes continue to work for blob storage. [#111246][#111246]
- Fixes a potential bug where changing the setting `server.telemetry.hot_ranges_stats.interval` directly after startup is a no-op.  Fixes: #111104 [#111373][#111373]
- Add check for values before using `mean` on Plan Details page, no longer causing a crash. [#111505][#111505]
- Fixed a bug where dependencies on sequences from tables would be reported with the wrong value for the classid column in the pg_catalog.pg_depend table. [#111600][#111600]
- Fixed a bug that could cause a transaction performing multiple parallel foreign key checks to return a `concurrent txn use detected` error. [#111600][#111600]
- Remove buggy TTL descriptor repair. Previously, upgrading from 22.2.X to 23.1.9 incorrectly removed TTL storage params from tables (visible via `SHOW CREATE TABLE <ttl-table>;`) while attempting to repair table descriptors. This resulted in the node that attempts to run the TTL job crashing due to a panic caused by the missing TTL storage params. Clusters currently on 22.2.X should NOT be upgraded to 23.1.9 and should be upgraded to 23.1.10 or later directly. [#111600][#111600]
- Atttypmod in pg_attribute was not populated for timestamp / interval types. [#111727][#111727]
- In txn insight details, we will only surface contention details for the current txn and no others. Previously it was possible to see the contention details of other txns due to a bug. [#111880][#111880]
- Indoption inside pg_index was not properly encoded, causing clients to be unable to decode it as int2vector. [#111957][#111957]
- Properly handles RPC failures on writes using the parallel commit protocol that execute in parallel to the commit operation, avoiding incorrect retryable failures and `transaction unexpectedly committed` assertions by detecting when writes cannot be retried idempotently, instead returning an `AmbiguousResultError`. [#111876][#111876]
- This patch fixes an issue where the optimizer fails to honor the `statement_timeout` session setting when generating constrained index scans for queries with large IN lists or `= ANY` predicates on multiple index key columns, which may lead to an out of memory condition on the node. [#112076][#112076]
- A bug has been fixed that caused internal errors during query optimization in rare cases. The bug has been present since version 2.1.11, but it is more likely to occur in version 21.2.0 and later, though it is still rare. The bug only presents when a query contains `min` and `max` aggregate functions. [#112254][#112254]
- CockroachDB previously could incorrectly evaluate lookup and index joins into tables with at least 3 column families in some cases (either "non-nullable column with no value" internal error would occur or the query would return incorrect results), and this is now fixed. The bug was introduced in 22.2. [#113107][#113107]

<h3 id="v23-1-12-performance-improvements">Performance improvements</h3>

- Queries that access the pg_catalog and information_schema that perform introspection on other tables in those schemas are now signicantly faster. [#110246][#110246]
- Queries that compare collated strings now use less memory and may execute faster. [#110147][#110147]
- The impact of high concurrency blind writes to the same key on goroutine scheduling latency was reduced. [#109370][#109370]

<h3 id="v23-1-12-miscellaneous">Miscellaneous</h3>

<h4 id="v23-1-12-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#111075][#111075] [5b78f1812][5b78f1812] Revert "release-23.1: metrics: refactor histogram bucket generation and testing" (Eric Harmeling <eric.harmeling@cockroachlabs.com>)
- [#110588][#110588] [d3ec7909c][d3ec7909c] release-23.1: sql: fix system database survival on create or drop database (Jeff Swenson <swenson@cockroachlabs.com>)

<h3 id="v23-1-12-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-12-contributors">Contributors</h3>

This release includes 207 merged PRs by 64 authors.
We would like to thank the following contributors from the CockroachDB community:

- Darryl Wong (first-time contributor, CockroachDB team member)
- David Hartunian (first-time contributor, CockroachDB team member)
- Mark Sirek (first-time contributor, CockroachDB team member)
- craig (first-time contributor)
- rail (first-time contributor)
- rharding6373
- zachlite

</div>

[#109370]: https://github.com/cockroachdb/cockroach/pull/109370
[#109639]: https://github.com/cockroachdb/cockroach/pull/109639
[#109684]: https://github.com/cockroachdb/cockroach/pull/109684
[#109840]: https://github.com/cockroachdb/cockroach/pull/109840
[#109849]: https://github.com/cockroachdb/cockroach/pull/109849
[#109881]: https://github.com/cockroachdb/cockroach/pull/109881
[#109902]: https://github.com/cockroachdb/cockroach/pull/109902
[#110147]: https://github.com/cockroachdb/cockroach/pull/110147
[#110207]: https://github.com/cockroachdb/cockroach/pull/110207
[#110246]: https://github.com/cockroachdb/cockroach/pull/110246
[#110256]: https://github.com/cockroachdb/cockroach/pull/110256
[#110266]: https://github.com/cockroachdb/cockroach/pull/110266
[#110296]: https://github.com/cockroachdb/cockroach/pull/110296
[#110337]: https://github.com/cockroachdb/cockroach/pull/110337
[#110338]: https://github.com/cockroachdb/cockroach/pull/110338
[#110342]: https://github.com/cockroachdb/cockroach/pull/110342
[#110359]: https://github.com/cockroachdb/cockroach/pull/110359
[#110369]: https://github.com/cockroachdb/cockroach/pull/110369
[#110453]: https://github.com/cockroachdb/cockroach/pull/110453
[#110497]: https://github.com/cockroachdb/cockroach/pull/110497
[#110500]: https://github.com/cockroachdb/cockroach/pull/110500
[#110507]: https://github.com/cockroachdb/cockroach/pull/110507
[#110564]: https://github.com/cockroachdb/cockroach/pull/110564
[#110584]: https://github.com/cockroachdb/cockroach/pull/110584
[#110588]: https://github.com/cockroachdb/cockroach/pull/110588
[#110611]: https://github.com/cockroachdb/cockroach/pull/110611
[#110662]: https://github.com/cockroachdb/cockroach/pull/110662
[#110666]: https://github.com/cockroachdb/cockroach/pull/110666
[#110680]: https://github.com/cockroachdb/cockroach/pull/110680
[#110717]: https://github.com/cockroachdb/cockroach/pull/110717
[#110720]: https://github.com/cockroachdb/cockroach/pull/110720
[#110741]: https://github.com/cockroachdb/cockroach/pull/110741
[#110746]: https://github.com/cockroachdb/cockroach/pull/110746
[#110940]: https://github.com/cockroachdb/cockroach/pull/110940
[#110963]: https://github.com/cockroachdb/cockroach/pull/110963
[#110983]: https://github.com/cockroachdb/cockroach/pull/110983
[#111006]: https://github.com/cockroachdb/cockroach/pull/111006
[#111014]: https://github.com/cockroachdb/cockroach/pull/111014
[#111058]: https://github.com/cockroachdb/cockroach/pull/111058
[#111075]: https://github.com/cockroachdb/cockroach/pull/111075
[#111131]: https://github.com/cockroachdb/cockroach/pull/111131
[#111141]: https://github.com/cockroachdb/cockroach/pull/111141
[#111246]: https://github.com/cockroachdb/cockroach/pull/111246
[#111278]: https://github.com/cockroachdb/cockroach/pull/111278
[#111287]: https://github.com/cockroachdb/cockroach/pull/111287
[#111310]: https://github.com/cockroachdb/cockroach/pull/111310
[#111373]: https://github.com/cockroachdb/cockroach/pull/111373
[#111412]: https://github.com/cockroachdb/cockroach/pull/111412
[#111496]: https://github.com/cockroachdb/cockroach/pull/111496
[#111505]: https://github.com/cockroachdb/cockroach/pull/111505
[#111600]: https://github.com/cockroachdb/cockroach/pull/111600
[#111641]: https://github.com/cockroachdb/cockroach/pull/111641
[#111652]: https://github.com/cockroachdb/cockroach/pull/111652
[#111727]: https://github.com/cockroachdb/cockroach/pull/111727
[#111876]: https://github.com/cockroachdb/cockroach/pull/111876
[#111880]: https://github.com/cockroachdb/cockroach/pull/111880
[#111901]: https://github.com/cockroachdb/cockroach/pull/111901
[#111957]: https://github.com/cockroachdb/cockroach/pull/111957
[#112038]: https://github.com/cockroachdb/cockroach/pull/112038
[#112076]: https://github.com/cockroachdb/cockroach/pull/112076
[#112204]: https://github.com/cockroachdb/cockroach/pull/112204
[#112254]: https://github.com/cockroachdb/cockroach/pull/112254
[#112323]: https://github.com/cockroachdb/cockroach/pull/112323
[#113107]: https://github.com/cockroachdb/cockroach/pull/113107
[5b78f1812]: https://github.com/cockroachdb/cockroach/commit/5b78f1812
[d3ec7909c]: https://github.com/cockroachdb/cockroach/commit/d3ec7909c
