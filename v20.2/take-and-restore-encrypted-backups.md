---
title: Take and Restore Encrypted Backups
summary: Learn about the advanced options you can use when you backup and restore a CockroachDB cluster.
toc: true
---

The ability to [backup a full cluster](backup.html#backup-a-cluster) has been added and the syntax for [incremental backups](backup.html#create-incremental-backups) is simplified. Because of these two changes, [basic backup usage](take-full-and-incremental-backups.html) is now sufficient for most CockroachDB clusters. However, you may want to control your backup and restore options more explicitly.

This doc provides information about how to take and restore encrypted backups in the following ways:

- <span class="version-tag">New in v20.2:</span> [Using AWS Key Management Service (KMS)](#use-aws-key-management-service)
- [Using a passphrase](#use-a-passphrase)

{{site.data.alerts.callout_info}}
[`BACKUP`](backup.html) is an [enterprise-only](https://www.cockroachlabs.com/product/cockroachdb/) feature. For non-enterprise backups, see [`cockroach dump`](cockroach-dump.html).
{{site.data.alerts.end}}

## Use AWS Key Management Service

<span class="version-tag">New in v20.2:</span> You can encrypt full or incremental backups with AWS Key Management Service (KMS) by using the [`kms` option](backup.html#options). Files written by the backup (including `BACKUP` manifests and data files) are encrypted using the specified URI. To restore the encrypted backup, the same `kms` option (with the same URI) must be included in the [`RESTORE`](restore.html) statement.

When used with [incremental backups](backup.html#incremental-backups), the `kms` option is applied to all the [backup file URLs](backup.html#backup-file-urls), which means the same KMS URI must be used when appending another incremental backup to an existing backup. Similarly, when used with [locality-aware backups](take-and-restore-locality-aware-backups.html), the KMS URI provided is applied to files in all localities.

AWS provides [extensive documentation on KMS](https://aws.amazon.com/kms/) but two key concepts to understand are:

- **Customer Master Keys (CMK)**: This is the master key generated by AWS KMS and it never leaves the KMS. It contains key-related metadata and key material to encrypt/decrypt other data. The key material can never be exported, deleted, or extracted. CockroachDB expects the CMK to be symmetric (256 bit).

    There is also the option to use a multi-region CMK encrypt your data. In the case of a single KMS region outage, the data can be decrypted with any of the CMKs from the other regions.

- **Data Keys**: These are the keys that are generated for the purpose of encrypting/decrypting large amounts of data. Data keys live outside of the KMS, and are managed where they are used. The above-mentioned CMK is used to generate each of these data keys by the KMS. CockroachDB expects the data keys to be symmetric.

User-specified credentials must be "specified" through the URI scheme. To [encrypt full or incremental backups with AWS KMS](#take-an-encrypted-backup-with-aws-kms), use the [`kms` option](backup.html#options). Files written by the backup (including `BACKUP` manifests and data files) are encrypted with the KMS URI (or list of KMS URIs). This same KMS URI is needed to decrypt the file when it is used to [restore](#restore-from-an-encrypted-backup-with-aws-kms) and to list the contents of the backup when using [`SHOW BACKUP`](show-backup.html#show-an-encrypted-backup).

### AWS KMS URI format

The AWS KMS URI must use the following format:

~~~
aws:///arn:aws:kms:<region>:<user-id>:key/<key-id>?<auth>&REGION=<region>
~~~

The AWS URI must:

- Use the `aws:///` scheme (note the triple slash)
- Use authentication (replace the `<auth>` placeholder), which can either be:

   - **Implicit**: Use `AUTH=implicit` and the [credentials will be loaded from the environment](https://docs.aws.amazon.com/sdk-for-go/api/aws/session/)
   - **Explicit**: Use `AWS_ACCESS_KEYID=<key-id>&AWS_SECRET_ACCESS_KEY=<secret-key>`

- `REGION` is required and must be all caps

See below for an [example](#take-an-encrypted-backup-with-aws-kms).

### Take an encrypted backup with AWS KMS

To take an encrypted backup with AWS KMS, use the `kms` [option](backup.html#options):

{% include copy-clipboard.html %}
~~~ sql
> BACKUP TO 's3:///test/backups/test_kms?AWS_ACCESS_KEY_ID=123456&AWS_SECRET_ACCESS_KEY=123456'
    WITH kms = 'aws:///arn:aws:kms:us-east-1:123456789:key/1234-abcd-5678-efgh-90ij?AWS_ACCESS_KEY_ID=123456&AWS_SECRET_ACCESS_KEY=123456&REGION=us-east-1';
~~~

~~~
        job_id       |  status   | fraction_completed | rows | index_entries |  bytes
---------------------+-----------+--------------------+------+---------------+----------
  594193600274956289 | succeeded |                  1 | 2689 |          1217 | 1420108
(1 row)
~~~

### Restore from an encrypted backup with AWS KMS

To decrypted an [encrypted backup](#take-an-encrypted-backup-with-aws-kms), use the `kms` option and the same KMS URI that was used to take the backup.

For example, the encrypted backup created in the [previous example](#take-an-encrypted-backup-with-aws-kms) can be restored with:

{% include copy-clipboard.html %}
~~~ sql
> RESTORE FROM 's3:///test/backups/test_kms?AWS_ACCESS_KEY_ID=123456&AWS_SECRET_ACCESS_KEY=123456'
    WITH kms = 'aws:///arn:aws:kms:us-east-1:123456789:key/1234-abcd-5678-efgh-90ij?AWS_ACCESS_KEY_ID=123456&AWS_SECRET_ACCESS_KEY=123456&REGION=us-east-1';
~~~

~~~
        job_id       |  status   | fraction_completed | rows | index_entries |  bytes
---------------------+-----------+--------------------+------+---------------+----------
  594193600274956291 | succeeded |                  1 | 2689 |          1217 | 1420108
(1 row)
~~~

## Use a passphrase

{% include {{ page.version.version }}/backups/encrypted-backup-description.md %}

### Take an encrypted backup using a passphrase

To take an encrypted backup, use the `encryption_passphrase` option:

{% include copy-clipboard.html %}
~~~ sql
> BACKUP TO \
'gs://acme-co-backup/test-cluster' \
WITH encryption_passphrase = 'password123';
~~~
~~~
        job_id       |  status   | fraction_completed | rows | index_entries | bytes
---------------------+-----------+--------------------+------+---------------+---------
  543214409874014209 | succeeded |                  1 | 2597 |          1028 | 467701
(1 row)
~~~

To [restore](restore.html), use the same `encryption_passphrase`. See the [example](#restore-from-an-encrypted-backup-using-a-passphrase) below for more details.

### Restore from an encrypted backup using a passphrase

To decrypt an [encrypted backup](#take-an-encrypted-backup-using-a-passphrase), use the `encryption_passphrase` option and the same passphrase that was used to create the backup.

For example, the encrypted backup created in the [previous example](#take-an-encrypted-backup-using-a-passphrase) can be restored with:

{% include copy-clipboard.html %}
~~~ sql
> RESTORE FROM \
'gs://acme-co-backup/test-cluster' \
WITH encryption_passphrase = 'password123';
~~~
~~~
        job_id       |  status   | fraction_completed | rows | index_entries | bytes
---------------------+-----------+--------------------+------+---------------+---------
  543217488273801217 | succeeded |                  1 | 2597 |          1028 | 467701
(1 row)
~~~

## See also

- [`BACKUP`][backup]
- [`RESTORE`][restore]
- [Take Full and Incremental Backups](take-full-and-incremental-backups.html)
- [Take and Restore Locality-aware Backups](take-and-restore-locality-aware-backups.html)
- [Take Backups with Revision History and Restore from a Point-in-time](take-backups-with-revision-history-and-restore-from-a-point-in-time.html)
- [`SQL DUMP`](cockroach-dump.html)
- [`IMPORT`](import-data.html)
- [Use the Built-in SQL Client](cockroach-sql.html)
- [Other Cockroach Commands](cockroach-commands.html)

<!-- Reference links -->

[backup]:  backup.html
[restore]: restore.html
