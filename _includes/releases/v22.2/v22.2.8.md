## v22.2.8

Release Date: April 17, 2023

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v22-2-8-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- [Backup schedules](../v22.2/manage-a-backup-schedule.html) created or altered to have the option `on_previous_running` will now have the full backup schedule created with the user specified option, but will override the incremental backup schedule to always default to `on_previous_running = wait`. This prevents duplicate incremental jobs from racing against each other, and ensures correctness of the backup chains created by the incremental schedule. [#98860][#98860]
- [AVRO](../v22.2/changefeed-messages.html#avro) schema registry URI now allow additional `timeout=T` query parameter to change the default timeout for contacting schema registry. [#99505][#99505]

<h3 id="v22-2-8-sql-language-changes">SQL language changes</h3>

- Fixed the helper message on the [UPDATE](../v22.2/update.html) statement to correctly position the optional `FROM` clause. [#99299][#99299]
- Added a new `prepared_statements_cache_size` [cluster setting](../v22.2/cluster-settings.html) which, when set to a non-zero number of bytes, causes the least recently-used prepared statements to be automatically deallocated when prepared statement memory usage goes above the cache size. This setting can be used to avoid prepared statement leaks from long-lived connections which never `DEALLOCATE` prepared statements. [#99259][#99259]
- Added two new [cluster settings](../v22.2/cluster-settings.html) that enable users to change the number of histogram samples and buckets collected when building histograms as part of table statistics collection: `sql.stats.histogram_samples.count` and `sql.stats.histogram_buckets.count`. While the default values should work for most cases, it may be beneficial to increase the number of samples and buckets for very large tables to avoid creating a histogram that misses important values. [#100544][#100544]

<h3 id="v22-2-8-operational-changes">Operational changes</h3>

- The `kv.trace.slow_request_stacks.threshold` [cluster setting](../v22.2/cluster-settings.html) can be used to attach available stack history from tracer snapshots to the trace of slow requests. [#99738][#99738]

<h3 id="v22-2-8-db-console-changes">DB Console changes</h3>

- New data is now automatically fetched every 5 minutes on the [Statement](../v22.2/ui-statements-page.html) and [Transaction](../v22.2/ui-transactions-page.html) pages. [#99271][#99271]
- On DB console Stats pages, issuing a new request for stats while one is pending is now allowed and will replace the pending request. [#99271][#99271]

<h3 id="v22-2-8-bug-fixes">Bug fixes</h3>

- Prepared statements using placeholders in recursive [common table expressions](../v22.2/common-table-expressions.html) did not always re-optimize correctly after plugging in the parameters, which led to poor plan choices. This has been fixed. [#100327][#100327]
- Fixed a bug where glob patterns that did not match tables in [`GRANT`](../v22.2/grant.html) or [`REVOKE`](../v22.2/revoke.html) statements would return an internal error with a confusing message instead of the `"no objects matched"` error. [#99437][#99437]
- Since v22.2.0, CockroachDB could crash with the `"attempting to append refresh spans after the tracked timestamp has moved forward"` error in some rare cases (most likely when querying `pg_catalog` and `crdb_internal` virtual tables). This has been fixed. The workaround before upgrading would be to run `SET CLUSTER SETTING sql.distsql.use_streamer.enabled = false;`. [#99445][#99445]
- When using `cluster_logical_timestamp()` as a [`DEFAULT`](../v22.2/default-value.html) expression, the node would sometimes crash. This has been fixed.[#99662][#99662]
- The [`ALTER DEFAULT PRIVILEGES ... ON FUNCTIONS ...`](../v22.2/alter-default-privileges.html) statement is no longer allowed unless all nodes are running on v22.2 and the upgrade is finalized. This prevents a bug where executing this command in a mixed version cluster could cause nodes still running on v22.1 to crash. [#99845][#99845]
- Fixed a bug where the [`TRUNCATE TABLE`](../v22.2/truncate.html) GC job can be stuck in running status if the table descriptor has been GCed. This happened because `TRUNCATE TABLE` creates new empty indexes, then replaces and drops the old indexes. The dropped indexes data are deleted and GCed within the `TRUNCATE TABLE` GC job, which are needed to see the table descriptor make progress. However, if the table data has been GCed, the job couldn't make progress. This patch makes the GC job able to handle the missing descriptor edge case and let the `TRUNCATE TABLE` GC job succeed. [#100137][#100137]
- Fixed a bug that would cause the gateway node to crash if there are self-referencing [views](../v22.2/views.html). This bug is present since at least v21.1. [#100163][#100163]
- Fixed a bug where queries reading from virtual tables (e.g. `crdb_internal.*` and `pg_catalog.*` tables) could hang indefinitely in the rare case when they resulted in an error. [#99968][#99968]
- In rare cases involving overload and schema changes, users could sometimes, transiently, see errors of the form `"deadline below read timestamp is nonsensical; txn has would have no chance to commit"`. These errors carried an internal pgcode and could not be retried. This form of error is now classified as a retriable error and will be retried automatically either by the client or internally. [#100255][#100255]
- Fixed a bug where the `sql.mem.distsql.current` metric would double count the memory usage of remote DistSQL flows. [#100254][#100254]
- Fixed a bug that could prevent a cached query with a [user-defined type](../v22.2/create-type.html) reference from being invalidated, even after a schema change that should prevent the type from being resolved. [#100223][#100223]
- Fixed a bug that could prevent a cached query from being invalidated when a [user-defined function](../v22.2/user-defined-functions.html) referenced by that query was altered or dropped. [#100223][#100223]
- Fixed a bug where [user-defined functions](../v22.2/user-defined-functions.html) were introduced that could cause a function call to resolve to the wrong function after changes to the schema search path. [#100223][#100223]
- Fixed a rare bug existing since before v22.1 that could cause a projected expression to replace column references with the wrong values. [#97593][#97593]
- Fixed a bug where concurrent DML queries could corrupt an existing primary index when [adding a new column](../v22.2/alter-table.html) with a new column family. If a rollback occurs the table may no longer be accessible. [#100187][#100187]

<h3 id="v22-2-8-performance-improvements">Performance improvements</h3>

- Removed prettify usages that could cause OOM on [Statements](../v22.2/ui-statements-page.html) and [Transactions](../v22.2/ui-transactions-page.html) page. [#99453][#99453]
- Audit logging could incur extra latency when resolving table/view/sequence names. To address this, this patch adds support for using the lease cache for these looks up and eliminate any extra round trips. [#99661][#99661]
- The execution of multiple [`FOREIGN KEY`](../v22.2/foreign-key.html) and [`UNIQUE`](../v22.2/unique.html) constraint checks can be parallelized in some cases. As a result, these checks can be completed faster, especially so in multi-region environments where the checks require cross-region reads. The feature is enabled by default on v23.1 release, and in order to enable it on v22.2, one must change the private `sql.distsql.parallelize_checks.enabled` [cluster setting](../v22.2/cluster-settings.html) to `true`. [#100520][#100520]

<h3 id="v22-2-8-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v22-2-8-contributors">Contributors</h3>

This release includes 56 merged PRs by 37 authors.
We would like to thank the following contributors from the CockroachDB community:

- Eric.Yang

</div>

[#100137]: https://github.com/cockroachdb/cockroach/pull/100137
[#100163]: https://github.com/cockroachdb/cockroach/pull/100163
[#100187]: https://github.com/cockroachdb/cockroach/pull/100187
[#100223]: https://github.com/cockroachdb/cockroach/pull/100223
[#100254]: https://github.com/cockroachdb/cockroach/pull/100254
[#100255]: https://github.com/cockroachdb/cockroach/pull/100255
[#100327]: https://github.com/cockroachdb/cockroach/pull/100327
[#100520]: https://github.com/cockroachdb/cockroach/pull/100520
[#100544]: https://github.com/cockroachdb/cockroach/pull/100544
[#97593]: https://github.com/cockroachdb/cockroach/pull/97593
[#98860]: https://github.com/cockroachdb/cockroach/pull/98860
[#99259]: https://github.com/cockroachdb/cockroach/pull/99259
[#99271]: https://github.com/cockroachdb/cockroach/pull/99271
[#99299]: https://github.com/cockroachdb/cockroach/pull/99299
[#99437]: https://github.com/cockroachdb/cockroach/pull/99437
[#99445]: https://github.com/cockroachdb/cockroach/pull/99445
[#99453]: https://github.com/cockroachdb/cockroach/pull/99453
[#99505]: https://github.com/cockroachdb/cockroach/pull/99505
[#99661]: https://github.com/cockroachdb/cockroach/pull/99661
[#99662]: https://github.com/cockroachdb/cockroach/pull/99662
[#99738]: https://github.com/cockroachdb/cockroach/pull/99738
[#99845]: https://github.com/cockroachdb/cockroach/pull/99845
[#99968]: https://github.com/cockroachdb/cockroach/pull/99968
