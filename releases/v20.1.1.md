---
title: What&#39;s New in v20.1.1
toc: true
summary: Additions and changes in CockroachDB version v20.1.1 since version v20.1.0
---

## May 26, 2020

Get future release notes emailed to you:

<div class="hubspot-install-form install-form-1 clearfix">
    <script>
        hbspt.forms.create({
            css: '',
            cssClass: 'install-form',
            portalId: '1753393',
            formId: '39686297-81d2-45e7-a73f-55a596a8d5ff',
            formInstanceId: 1,
            target: '.install-form-1'
        });
    </script>
</div>

### Downloads

<div id="os-tabs" class="clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v20.1.1.darwin-10.9-amd64.tgz"><button id="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v20.1.1.linux-amd64.tgz"><button id="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v20.1.1.windows-6.2-amd64.zip"><button id="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v20.1.1.src.tgz"><button id="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v20.1.1
~~~

### Backward-incompatible changes

- The copy of `system` and `crdb_internal` tables extracted by `cockroach debug zip` is now written using the TSV format (inside the .zip file), instead of an ASCII-art table. [#48094][#48094]
- Updated the textual error and warning messages displayed by `cockroach quit`. [#47692][#47692]
- `cockroach quit` now prints progress details on its standard error stream, even when `--logtostderr` is not specified. Scripts that wish to ignore this output can redirect the standard error stream. [#47692][#47692]
- CockroachDB v20.1 introduced a new rule for the `--join` flag causing it to prefer SRV records, if present in DNS, to look up the peer nodes to join. This feature is experimental. However, it is also found to cause disruption in in certain deployments. To reduce this disruption and UX surprise, the feature is now gated behind a new command-line flag `--experimental-dns-srv` which must now be explicitly passed to `cockroach start` to enabled it. [#49129][#49129]
- Prior to this patch, the phase of server shutdown responsible for range lease transfers to other nodes would give up after 10000 attempts of transferring replica leases away, regardless of the value of `server.shutdown.lease_transfer_wait`. The limit of 10000 attempts has been removed, so that now only the maximum duration `server.shutdown.lease_transfer_wait` applies. [#47692][#47692]

### General changes

- Added a new cluster setting, `server.shutdown.lease_transfer_wait`, that allows you to configure the server shutdown timeout period for transferring range leases to other nodes. Previously, the timeout period was not configurable and was set to 5 seconds. [#47692][#47692]
- Statement diagnostics zip bundles now contain a representation of the statement trace that can be imported into Jaeger for visualization. [#47432][#47432]

### Enterprise edition changes

- Fixed a bug where the job ID of a lagging changefeed would be omitted, and instead it would be reported as sinkless. [#48562][#48562]

### SQL language changes

- The `pg_collation`, `pg_proc`, `pg_database`, and `pg_type` tables in the `pg_catalog` database no longer require privileges on any database in order for the data to be visible. [#48080][#48080], [#48765][#48765]
- Histogram collection with `CREATE STATISTICS` is no longer supported on columns with type `array`. Only row count, distinct count, and null count are collected for array-type columns. [#48343][#48343]
- `ROLLBACK TO SAVEPOINT` is no longer permitted after miscellaneous internal errors. [#48305][#48305]
- Fixed an issue with optimizing subqueries involving set operations that can prevent queries from executing. [#48680][#48680]
- Correctly report type length for `char` type. [#48642][#48642]
- The `RowDescription` message of the `pgwire` protocol now contains the table OID and column ID for each column in the result set. These values correspond to `pg_attribute.attrelid` and `pg_attribute.attnum`. If a result column does not refer to a simple table or view, these values will be zero, as they were before. [#48748][#48748]
- The `RowDescription` message of the `pgwire` protocol now contains the type modifier for each column in the result set. This corresponds to `pg_attribute.atttypmod`. If it is not available, the value is `-1`, as it was before. [#49087][#49087]

### Command-line changes

- `debug zip` now properly skips over fully decommissioned nodes. [#48094][#48094]
- `cockroach debug zip` now tries multiple times to retrieve data using SQL if it encounters retry errors. [#48094][#48094]
- `cockroach debug zip` now supports two command-line parameters `--nodes` and `--exclude-nodes`. When specified, they control which nodes are inspected when gathering the data. This makes it possible to focus on a group of nodes of interest in a large cluster, or to exclude nodes that `debug zip` would have trouble reaching otherwise. Both flags accept a list of individual node IDs or ranges of node IDs, e.g. `--nodes=1,10,13-15`. [#48094][#48094]
- Client commands such as `cockroach init` and `cockroach quit` now support the `--cluster-name` and `--disable-cluster-name-verification` flags in order to support running them on clusters that have been configured to use a cluster name. Previously it was impossible to run such commands against nodes configured with the `--cluster-name` flag. [#48016][#48016]
- The time that `cockroach quit` waits client-side for the node to drain (remove existing clients and push range leases away) is now configurable via the command-line flag `--drain-wait`. Note that separate server-side timeouts also apply separately. Check the `server.shutdown.*` cluster settings for details. [#47692][#47692]
- It is now possible to drain a node without shutting down the process, using `cockroach node drain`. This makes it easier to integrate with service managers and orchestration: it now becomes safe to issue `cockroach node drain` and then separately stop the service via a process manager or orchestrator. Without this new mode, there is a risk to misconfigure the service manager to auto-restart the node after it shuts down via `quit`, in a way that's surprising or unwanted. The new command `node drain` also recognizes the new `--drain-wait` flag. [#47692][#47692]
- The commands `cockroach quit` and `cockroach node drain` now reports a "work remaining" metric on their standard error stream. The value reduces until it reaches `0` to indicate that the graceful shutdown has completed server-side. An operator can now rely on `cockroach node drain` to obtain confidence of a graceful shutdown prior to terminating the server process. [#47692][#47692]
- The default value of the paramater `--drain-wait` for `cockroach quit` has been increased from 1 minute to 10 minutes, to give more time for nodes with thousands of ranges to migrate their leases away. [#47692][#47692]
- Added support for `list cert` with certificates which require `--cert-principal-map` to pass validation. [#48177][#48177]
- Added support for the `--cert-principal-map` flag in the `cert *` and "client" commands such as `sql`, `init`, and `quit`. [#48177][#48177]
- Make `--storage-engine` sticky (i.e. resolve to the last used engine type when unspecified) even when specified stores are encrypted at rest. [#49073][#49073]

### Admin UI changes

- Fixed a bug where `Raft log too large` was reported incorrectly for replicas for which the raft log size is not to be trusted. [#48286][#48286]
- Fixed a bug where a multi-node cluster without localities defined wouldn't be able to render the **Network Latency** page. [#49191][#49191]
- Fixed bug where link to specific problem ranges had an incorrect path. Problem ranges are now linked correctly again. [#49188][#49188]

### Bug fixes

- Fixed an error where instead of returning a parsing error in queries with `count(*)` CockroachDB could incorrectly return no output (when the query was executed via row-by-row engine). [#47485][#47485]
- Previously, CockroachDB was incorrectly releasing memory used by hash aggregation (we were releasing the correct amount from the internal memory accounting system but, by mistake, were keeping the references to the actual memory for some time which prohibited the memory to be garbage collected). This could lead to a crash (which was more likely when hash aggregation had store on the order of 100k of groups) and is now fixed. [#47518][#47518]
- `cockroach debug zip` can now successfully avoid out-of-memory errors when extracting very large `system` or `crdb_internal` tables. [#48094][#48094]
- `cockroach debug zip` will now properly report an error if some error is encountered while writing the end of the output ZIP file. [#48094][#48094]
- Removed redundant metadata information for subqueries and postqueries in `EXPLAIN (VERBOSE)` output. [#47975][#47975]
- `TRUNCATE` can now run on temporary tables, fixing a bug in 20.1.0 where temporary tables could not be truncated, resulting in an error `unexpected value: nil`. [#48078][#48078]
- Fixed a bug in which `(tuple).*` was only expanded to the first column in the tuple and the remaining elements were dropped. [#48290][#48290]
- Fixed case where `PARTITION BY` and `ORDER BY` columns in window specifications were losing qualifications when used inside views. [#47715][#47715]
- CockroachDB will now avoid producing a severe `internal error` upon certain privilege check failures via `pg_catalog` built-in functions. [#48242][#48242]
- Fixed a bug where a read operation in a transaction would error out for exceeding the maximum count of results returned. [#48165][#48165]
- Fixed a bug that could lead to data corruption or data loss if a replica was both the source of a snapshot and was being concurrently removed from the range and certain specific conditions exist inside RocksDB. This scenario is rare, but possible. [#48321][#48321]
- Better distinguish between the delete jobs for columns and dependent jobs for deleting indices, views and sequences. In the current state, clients were confused why more than 1 job was created from a `DROP COLUMN` statement. [#48259][#48259]
- Fixed incorrect results that could occur when casting negative intervals or timestamps to type decimal. [#48345][#48345]
- Fixed an error that occurred when statistics collection was explicitly requested on a column with type array. [#48343][#48343]
- Fixed a nil pointer dereference in Pebble's block cache due to a rare "double free" of a block. [#48346][#48346]
- Fix Pebble to properly mark `sstables` for compaction which contain range tombstones. This matches the behavior when using RocksDB and ensures that space used for temporary storage is reclaimed quickly. [#48346][#48346]
- Fixed a bug introduced in 20.1 that could cause multiple index GC jobs to be created for the same schema change in rare cases. [#47818][#47818]
- Fixed a bug where CockroachDB could return an internal error when performing a query with `CASE`, `AND`, `OR` operators in some cases when it was executed via the vectorized engine. [#48072][#48072]
- TLS 1.3 is now disabled by default to improve compatibility with Java. [#48365][#48365]
- Fixed a rare bug where stats were not automatically generated for a new table. [#48027][#48027]
- Fixed a panic that could occur when `SHOW RANGES` or `SHOW RANGE FOR ROW` was called with a virtual table. [#48347][#48347]
- Makes SRV resolution non-fatal for join list records to align with the standard and improve reliability of node startup. [#48349][#48349]
- Fixed a rare bug causing a range to deadlock and all the writes to the respective range to timeout. [#48303][#48303]
- Fixed a long-standing bug where HTTP requests would start to fail with error 503 "`transport: authentication handshake failed: io: read/write on closed pipe`" and never become possible again until the node is restarted. [#48456][#48456]
- Fixed a bug where vectorized queries on composite datatypes could sometimes return invalid data. [#48463][#48463]
- When processing `--join`, invalid SRV records with port number `0` are now properly ignored. [#48527][#48527]
- `SHOW STATISTICS USING JSON` contains incorrect single quotes for strings with spaces inside histograms. [#48544][#48544]
- Fixed a bug where the two settings `kv.range_split.by_load_enabled` and `kv.range_split.load_qps_threshold` were incorrectly marked as non-public in the output of `SHOW CLUSTER SETTINGS`. [#48585][#48585]
- Prevented dropping of databases which contain tables which are currently offline due to `IMPORT` or `RESTORE`. Previously dropping a database in this state could lead to a corrupted schema which prevented running backups. [#48606][#48606]
- Fixed a bug preventing timestamps from being closed which could result in failed follower reads or failure to observe resolved timestamps in changefeeds. [#48682][#48682]
- Fixed `debug encryption-status` and the Admin UI display of encryption status when using Pebble. [#47995][#47995]
- Previously, when an `IMPORT` failed, it created a GC job which would behave as a no-op. Now the partially imported data after an `IMPORT` fails or is canceled should be deleted. [#48605][#48605]
- Fixed a bug where the `SHOW CREATE` statement would sometimes show a partitioning step for an index that has been dropped. [#48768][#48768]
- Re-allow `diagnostics.forced_sql_stat_reset.interval`, `diagnostics.sql_stat_reset.interval` and `external.graphite.interval` to set to their maximum values (24hr, 24hr and 15min respectively). This previously only excluded these values to be allowed. [#48760][#48760]
- Previously, CockroachDB could encounter an internal error when a query with `LEFT SEMI` or `LEFT ANTI` join was performed via the vectorized execution engine in some cases, and now this has been fixed. This is likely to occur only with `vectorize=on` setting. [#48751][#48751]
- Fixed a bug where `cockroach dump` on tables with interleaved primary keys would erroneously include and extra `CREATE UNIQUE INDEX "primary" ... INTERLEAVE IN PARENT` statement in the dump output. This made it impossible to reimport dumped data without manual editing. [#48776][#48776]
- Fixed a bug where `cockroach dump` on a table with collated strings would omit the collation clause for the data insertion statements. [#48832][#48832]
- Fixed a bug where the migration for ongoing schema change jobs would cause the node to panic with an index out of bounds error, upon encountering a malformed table descriptor with no schema change mutation corresponding to the job to be migrated. [#48838][#48838]
- Properly support restoring tables that were backed up while they were in the middle of a schema change. [#48850][#48850]
- Manually writing a `NULL` value into the `system.users` table for the `hashedPassword` column will no longer cause a server crash during user authentication. [#48836][#48836]
- Fixed a bug where in rare circumstances cockroach may fail to open a store configured to use the Pebble storage engine. [#49080][#49080]
- Fixed a bug where in rare circumstances when configured to use the Pebble storage engine, the storage engine would return duplicate keys, causing incorrect or inconsistent results. [#49080][#49080]
- Fixed a bug where columns of a table could not be dropped after a primary key change. [#49088][#49088]
- Fixed a bug which falsely indicated that `kv.closed_timestamp.max_behind_nanos` was almost always growing. [#48716][#48716]
- Fixed a bug where changing the primary key of a table that had partitioned indexes could cause indexes to lose their zone configurations. In particular, the indexes that got rebuilt as part of a primary key change would keep their partitions but lose the zone configurations attached to those partitions. [#48827][#48827]
- Fixed costing of lookup join with a limit on top, resulting in better plans (that utilize lookup join) in some cases. [#49137][#49137]
- Fixed a bug where on dropping a database, it would not drop the entry for its public schema in the `system.namespace` table. [#49139][#49139]
- `SHOW BACKUP SCHEMAS` no longer shows table comments as they may be inaccurate. [#49130][#49130]
- Fixed a memory leak which can affect changefeeds performing scans of large tables. [#49161][#49161]
- Prevented namespace orphans (manifesting as `database "" not found` errors) when migrating from v19.2. [#49200][#49200]
- Fixed a bug with use of arrays combined with window functions causing a query failure. [#49238][#49238]

### Performance improvements

- Disabled the Go runtime block profile by default which results in a small but measurable reduction in CPU usage. The block profile has diminished in utility with the advent of mutex contention profiles and is almost never used during performance investigations. [#48153][#48153]
- The cleanup job which runs after a primary key change to remove old indexes, which blocks other schema changes from running, now starts immediately after the primary key swap is complete. This reduces the amount of waiting time before subsequent schema changes can run. [#47818][#47818]
- Histograms used by the optimizer for query planning now have more accurate row counts per histogram bucket, particularly for columns that have many null values. This results in better plans in some cases. [#48646][#48646]
- Fixed a bug in the histogram filtering logic in the optimizer which was causing inaccurate cardinality estimates for queries with equality predicates on UUIDs and strings, as well as some other types. This bug has existed since histograms were first introduced into the optimizer in the 19.2.0 release. Fixing it improves the optimizer's cardinality estimates and results in better query plans in some cases. [#48626][#48626]
- Before this a simple schema change could take 30s+. The reason was that if the schema change is not first in line in the table mutation queue it would return a re-triable error and the jobs framework will re-adopt and run it later. The problem is that the job adoption loop is 30s.  To repro run this for some time: ``` cockroach sql --insecure --watch 1s -e 'drop table if exists users cascade; create table users (id uuid not null, name varchar(255) not null, email varchar(255) not null, password varchar(255) not null, remember_token varchar(100) null, created_at timestamp(0) without time zone null, updated_at timestamp(0) without time zone null, deleted_at timestamp(0) without time zone null); alter table users add primary key (id); alter table users add constraint users_email_unique unique (email);' ```  Instead of returning on retriable errors we retry with a exponential backoff in the schema change code. This pattern of dealing with retriable errors in client job code is encouraged vs relying on the registry beacuse the latter leads to slowness and additionally to more complicated test fixtures that rely in hacking with the internals of the job registry, [#48621][#48621]
- Fixed a performance inefficiency in the vectorized execution engine which results in speed ups on all queries when run via the vectorized engine, with most noticeable gains on the queries that output many rows. [#48732][#48732]
- Reduced time needed to run a backup command when it is built on a lot of previous incremental backups. [#48772][#48772]

### Doc updates

Docs team: Please add these manually.

### Contributors

This release includes 94 merged PRs by 27 authors.
We would like to thank the following contributors from the CockroachDB community:

- Drew Kimball (first-time contributor)

[#47432]: https://github.com/cockroachdb/cockroach/pull/47432
[#47485]: https://github.com/cockroachdb/cockroach/pull/47485
[#47518]: https://github.com/cockroachdb/cockroach/pull/47518
[#47664]: https://github.com/cockroachdb/cockroach/pull/47664
[#47692]: https://github.com/cockroachdb/cockroach/pull/47692
[#47715]: https://github.com/cockroachdb/cockroach/pull/47715
[#47818]: https://github.com/cockroachdb/cockroach/pull/47818
[#47975]: https://github.com/cockroachdb/cockroach/pull/47975
[#47995]: https://github.com/cockroachdb/cockroach/pull/47995
[#48016]: https://github.com/cockroachdb/cockroach/pull/48016
[#48027]: https://github.com/cockroachdb/cockroach/pull/48027
[#48072]: https://github.com/cockroachdb/cockroach/pull/48072
[#48078]: https://github.com/cockroachdb/cockroach/pull/48078
[#48080]: https://github.com/cockroachdb/cockroach/pull/48080
[#48094]: https://github.com/cockroachdb/cockroach/pull/48094
[#48153]: https://github.com/cockroachdb/cockroach/pull/48153
[#48165]: https://github.com/cockroachdb/cockroach/pull/48165
[#48177]: https://github.com/cockroachdb/cockroach/pull/48177
[#48242]: https://github.com/cockroachdb/cockroach/pull/48242
[#48259]: https://github.com/cockroachdb/cockroach/pull/48259
[#48286]: https://github.com/cockroachdb/cockroach/pull/48286
[#48290]: https://github.com/cockroachdb/cockroach/pull/48290
[#48303]: https://github.com/cockroachdb/cockroach/pull/48303
[#48305]: https://github.com/cockroachdb/cockroach/pull/48305
[#48321]: https://github.com/cockroachdb/cockroach/pull/48321
[#48343]: https://github.com/cockroachdb/cockroach/pull/48343
[#48345]: https://github.com/cockroachdb/cockroach/pull/48345
[#48346]: https://github.com/cockroachdb/cockroach/pull/48346
[#48347]: https://github.com/cockroachdb/cockroach/pull/48347
[#48349]: https://github.com/cockroachdb/cockroach/pull/48349
[#48365]: https://github.com/cockroachdb/cockroach/pull/48365
[#48410]: https://github.com/cockroachdb/cockroach/pull/48410
[#48456]: https://github.com/cockroachdb/cockroach/pull/48456
[#48463]: https://github.com/cockroachdb/cockroach/pull/48463
[#48527]: https://github.com/cockroachdb/cockroach/pull/48527
[#48544]: https://github.com/cockroachdb/cockroach/pull/48544
[#48562]: https://github.com/cockroachdb/cockroach/pull/48562
[#48585]: https://github.com/cockroachdb/cockroach/pull/48585
[#48605]: https://github.com/cockroachdb/cockroach/pull/48605
[#48606]: https://github.com/cockroachdb/cockroach/pull/48606
[#48621]: https://github.com/cockroachdb/cockroach/pull/48621
[#48626]: https://github.com/cockroachdb/cockroach/pull/48626
[#48642]: https://github.com/cockroachdb/cockroach/pull/48642
[#48646]: https://github.com/cockroachdb/cockroach/pull/48646
[#48680]: https://github.com/cockroachdb/cockroach/pull/48680
[#48682]: https://github.com/cockroachdb/cockroach/pull/48682
[#48716]: https://github.com/cockroachdb/cockroach/pull/48716
[#48732]: https://github.com/cockroachdb/cockroach/pull/48732
[#48748]: https://github.com/cockroachdb/cockroach/pull/48748
[#48751]: https://github.com/cockroachdb/cockroach/pull/48751
[#48760]: https://github.com/cockroachdb/cockroach/pull/48760
[#48765]: https://github.com/cockroachdb/cockroach/pull/48765
[#48768]: https://github.com/cockroachdb/cockroach/pull/48768
[#48772]: https://github.com/cockroachdb/cockroach/pull/48772
[#48776]: https://github.com/cockroachdb/cockroach/pull/48776
[#48827]: https://github.com/cockroachdb/cockroach/pull/48827
[#48832]: https://github.com/cockroachdb/cockroach/pull/48832
[#48836]: https://github.com/cockroachdb/cockroach/pull/48836
[#48838]: https://github.com/cockroachdb/cockroach/pull/48838
[#48850]: https://github.com/cockroachdb/cockroach/pull/48850
[#49073]: https://github.com/cockroachdb/cockroach/pull/49073
[#49080]: https://github.com/cockroachdb/cockroach/pull/49080
[#49087]: https://github.com/cockroachdb/cockroach/pull/49087
[#49088]: https://github.com/cockroachdb/cockroach/pull/49088
[#49129]: https://github.com/cockroachdb/cockroach/pull/49129
[#49130]: https://github.com/cockroachdb/cockroach/pull/49130
[#49137]: https://github.com/cockroachdb/cockroach/pull/49137
[#49139]: https://github.com/cockroachdb/cockroach/pull/49139
[#49161]: https://github.com/cockroachdb/cockroach/pull/49161
[#49188]: https://github.com/cockroachdb/cockroach/pull/49188
[#49191]: https://github.com/cockroachdb/cockroach/pull/49191
[#49200]: https://github.com/cockroachdb/cockroach/pull/49200
[#49238]: https://github.com/cockroachdb/cockroach/pull/49238
